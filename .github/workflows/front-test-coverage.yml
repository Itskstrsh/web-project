name: frontend-coverage-80

on:
  pull_request:
    branches: [dev, main]
  push:
    branches: [dev]
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  frontend-coverage-80:
    name: frontend-coverage-80
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    env:
      CI: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm i; fi

      - name: Create jest environment with polyfills
        run: |
          cat > jest-environment.cjs <<'EOF'
          const { TextEncoder, TextDecoder } = require('util');
          const JSDOMEnvironment = require('jest-environment-jsdom').default;
          
          class CustomJSDOMEnvironment extends JSDOMEnvironment {
            constructor(...args) {
              super(...args);
              this.global.TextEncoder = TextEncoder;
              this.global.TextDecoder = TextDecoder;
            }
          }
          
          module.exports = CustomJSDOMEnvironment;
          EOF

      - name: Add Jest/Babel transformers
        working-directory: frontend
        run: |
          npm i -D @babel/core @babel/preset-env @babel/preset-react @babel/preset-typescript \
                 babel-jest jest-environment-jsdom identity-obj-proxy @testing-library/jest-dom
          
          if [ -f jest.setup.ts ]; then
            SETUP_LINE="setupFilesAfterEnv: ['<rootDir>/jest.setup.ts'],"
          elif [ -f jest.setup.js ]; then
            SETUP_LINE="setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],"
          elif [ -f jest.setup.cjs ]; then
            SETUP_LINE="setupFilesAfterEnv: ['<rootDir>/jest.setup.cjs'],"
          else
            SETUP_LINE="setupFilesAfterEnv: ['@testing-library/jest-dom'],"
          fi
          
          mkdir -p __mocks__
          echo "module.exports = 'file-mock';" > __mocks__/fileMock.js
          
          printf '%s\n' "const path = require('path');" \
            "" \
            "module.exports = {" \
            "  rootDir: path.resolve(__dirname)," \
            "  testEnvironment: path.resolve(__dirname, 'jest-environment.cjs')," \
            "  transform: {" \
            "    '^.+\\\\.(t|j)sx?$': ['babel-jest', {" \
            "      presets: [" \
            "        ['@babel/preset-env', { targets: { node: 'current' }, modules: 'commonjs' }]," \
            "        ['@babel/preset-react', { runtime: 'automatic' }]," \
            "        ['@babel/preset-typescript', { allowDeclareFields: true }]," \
            "      ]," \
            "    }]," \
            "  }," \
            "  moduleFileExtensions: ['ts','tsx','js','jsx','json']," \
            "  moduleNameMapper: {" \
            "    '\\\\.(css|less|sass|scss)$': 'identity-obj-proxy'," \
            "    '\\\\.(jpg|jpeg|png|gif|webp|svg)$': '<rootDir>/__mocks__/fileMock.js'," \
            "  }," \
            "  ${SETUP_LINE}" \
            "  collectCoverage: true," \
            "  collectCoverageFrom: [" \
            "    'src/**/*.{ts,tsx,js,jsx}'," \
            "    '!**/*.d.ts'," \
            "    '!**/*.test.*'," \
            "    '!**/__tests__/**'" \
            "  ]," \
            "  coverageDirectory: 'coverage/unit'," \
            "  coverageReporters: ['text','lcov','html']," \
            "  coverageThreshold: { global: { lines: 40 } }" \
            "};" > jest.ci.config.cjs

      - name: Run unit tests with coverage
        run: npx jest --config jest.ci.config.cjs --runInBand

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-report
          path: frontend/coverage/unit
          if-no-files-found: ignore